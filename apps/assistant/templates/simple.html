<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Продуктовый помощник</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            background-color: #f5f5f5;
            height: 100vh;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            padding: 16px;
            background-color: #202123;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 16px;
            padding: 16px;
            width: 100%;
        }

        .user-message {
            background-color: white;
        }

        .bot-message {
            background-color: #f7f7f8;
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 2px;
            background-color: #5436da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .bot-avatar {
            background-color: #10a37f;
        }

        .message-content {
            flex: 1;
            line-height: 1.5;
        }

        .product-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            display: flex;
            gap: 16px;
            background-color: white;
        }

        .product-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
        }

        .product-details {
            flex: 1;
        }

        .product-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .product-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .boycotted {
            background-color: #ffdede;
            color: #d32f2f;
        }

        .safe {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .alternatives-section {
            margin-top: 16px;
        }

        .alternatives-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .alternatives-list {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 12px;
        }

        .alternative-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            min-width: 150px;
            background-color: #f9f9f9;
        }

        .kyrgyz-product {
            border-left: 4px solid #4caf50;
        }

        .alternative-name {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .kyrgyz-badge {
            display: inline-block;
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 6px;
        }

        .chat-input-container {
            border-top: 1px solid #e0e0e0;
            padding: 16px;
            background-color: white;
        }

        .chat-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
            resize: none;
            min-height: 50px;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-input:focus {
            border-color: #10a37f;
        }

        .send-button {
            padding: 12px 20px;
            background-color: #10a37f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-button:hover {
            background-color: #0d906e;
        }

        .send-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loader {
            display: none;
            margin: 20px auto;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10a37f;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffdede;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100%;
                width: 100%;
                max-width: 100%;
            }

            .product-card {
                flex-direction: column;
            }

            .product-image {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <h1>Продуктовый помощник</h1>
    </div>

    <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
            <div class="avatar bot-avatar">Б</div>
            <div class="message-content">
                Здравствуйте! Я ваш помощник по продуктам. Задайте мне вопрос про любой продукт или его альтернативы.
            </div>
        </div>
    </div>

    <div class="error-message" id="errorMessage">
        Произошла ошибка при обработке запроса. Пожалуйста, попробуйте ещё раз.
    </div>

    <div class="loader" id="loader"></div>

    <div class="chat-input-container">
        <form class="chat-form" id="chatForm">
                <textarea
                        class="chat-input"
                        id="chatInput"
                        placeholder="Напишите сообщение..."
                        rows="1"
                        oninput="resizeTextarea(this)"
                ></textarea>
            <button class="send-button" type="submit" id="sendButton">
                Отправить
            </button>
        </form>
    </div>
</div>

<script>
    function resizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');
        const sendButton = document.getElementById('sendButton');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');

        chatForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            appendUserMessage(userMessage);

            chatInput.value = '';
            chatInput.style.height = 'auto';

            loader.style.display = 'block';
            errorMessage.style.display = 'none';
            sendButton.disabled = true;

            try {
                const response = await fetch('http://localhost:8000/assistant/simple/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({message: userMessage})
                });

                if (!response.ok) {
                    throw new Error('Ошибка запроса');
                }

                const data = await response.json();
                appendBotMessage(data);
            } catch (error) {
                console.error('Ошибка:', error);
                errorMessage.style.display = 'block';
            } finally {
                loader.style.display = 'none';
                sendButton.disabled = false;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });

        function appendUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message user-message';
            messageElement.innerHTML = `
                    <div class="avatar">П</div>
                    <div class="message-content">${message}</div>
                `;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendBotMessage(data) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message';
            let messageHTML = `
                    <div class="avatar bot-avatar">Б</div>
                    <div class="message-content">
                        ${data.text || ''}
                `;

            if (data.product) {
                const product = data.product;
                let statusClass = is_boycotted ? 'boycotted' : 'safe';
                let statusText = is_boycotted ? 'Бойкотируется' : 'Не бойкотируется';

                messageHTML += `
                        <div class="product-card">
{#                            ${product.image_url ? `<img src="${product.image_url}" alt="${name}" class="product-image">` : ''}#}
                            <div class="product-details">
                                <div class="product-name">${name}</div>
                                <div class="product-status ${statusClass}">${statusText}</div>
                                ${description ? `<p>${description}</p>` : ''}
                                ${boycott_reason ? `
                                    <div class="boycott-reason">
                                        <strong>${boycott_reason.title}</strong>: ${boycott_reason.description}
                                    </div>
                                ` : ''}
                    `;
            }

            messageHTML += `</div>`;  // Закрываем message-content

            messageElement.innerHTML = messageHTML;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        chatInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.requestSubmit();
            }
        });
    });
</script>
</body>
</html>
